;(function(a,b,c,d){a.widget("Mashup.audioControl",a.ui.mouse,{options:{sample:null,sliderThumbId:null},_create:function(){this._mouseInit(),this.options.sliderThumbId=this.element.attr("id"),this.vertical=!a(this.element).parent().parent().hasClass("horizontal"),this.track=this.element.siblings(".slider-track"),this.vertical?(this.trackMinTop=this.track.position().top,this.trackMaxTop=this.track.height()+this.trackMinTop-this.element.height()/2):(this.trackMinLeft=this.track.position().left,this.trackMaxLeft=this.track.width()+this.trackMinLeft-this.element.width()/2)},_mouseStart:function(a){this.vertical?(this.originalMousePosition=a.pageY,this.originalTop=parseInt(this.element.css("top").replace("px",""))):(this.originalMousePosition=a.pageX,this.originalLeft=parseInt(this.element.css("left").replace("px","")))},_mouseDrag:function(a){var b;if(this.vertical){var c=this.originalMousePosition-a.pageY,d=this.originalTop-c;d<=this.trackMinTop?d=this.trackMinTop:d>=this.trackMaxTop&&(d=this.trackMaxTop),this.element.css("top",d),b=1-d/(this.trackMaxTop-this.trackMinTop)}else{var c=this.originalMousePosition-a.pageX,e=this.originalLeft-c;e<=this.trackMinLeft?e=this.trackMinLeft:e>=this.trackMaxLeft&&(e=this.trackMaxLeft),this.element.css("left",e),b=1-e/(this.trackMaxLeft-this.trackMinLeft)}this.options.sample!==null&&this.options.sample.audioSampleGraphical("option",this.options.sliderThumbId,b)},_setOption:function(a,b){switch(a){case"someValue":break;default:this.options[a]=b}this._super("_setOption",a,b)},sliderSetPosition:function(b){if(this.vertical){var c=(1-b)*(this.trackMaxTop-this.trackMinTop);this.element.css("top",c);var d=(a(this.element).parent().width()-28)/2;a(this.element).css("left",d)}else{var e=(1-b)*(this.trackMaxLeft-this.trackMinLeft);this.element.css("left",e)}},_destroy:function(){}})})(jQuery,window,document)
;(function(a,b,c,d){a.widget("Mashup.audioPlayer",{options:{bpm:115,numberOfLoopBeats:16,rhythmIndex:0,beatIncrement:4,tracks:5},isGraphical:!1,rhythmIndex:0,isLoaded:!1,stopped:!0,_samples:[],_loadedSamples:[],_tracks:[],_effects:[],_uniqueSampleIdentifier:1,_create:function(){if(b.webkitAudioContext)this.context=new webkitAudioContext;else throw'This application requires a Web Audio API enabled browser.  Please download <a href="http://www.google.com/chrome" title="chrome" target="_blank">Chrome</a> to take part in the fun! (Trust me, its quick, painless and well worth it)';var c;this.context.createDynamicsCompressor?(this.compressor=this.context.createDynamicsCompressor(),this.compressor.connect(this.context.destination),c=this.compressor):c=this.context.destination,this.masterGainNode=this.context.createGainNode(),this.masterGainNode.gain.value=.7,this.masterGainNode.connect(c),this.effectLevelNode=this.context.createGainNode(),this.effectLevelNode.gain.value=1,this.effectLevelNode.connect(this.masterGainNode),this.isGraphical||this._setupTracks(),this.$player=a(this.element[0])},_addTrack:function(){var a=[];for(var b=0;b<this.options.numberOfLoopBeats;b++)a.push(0);this._tracks.push(a)},_addBeatsToTracks:function(a){var b=[];for(var c=0;c<a;c++)b.push(0);for(var d=0;d<this._tracks.length;d++)this._tracks[d]=this._tracks[d].concat(b)},_advanceNote:function(){var a=60/this.options.bpm;this.rhythmIndex++,this.rhythmIndex===this.options.numberOfLoopBeats*this.options.beatIncrement&&(this.rhythmIndex=0,this._currentBeat=0),this.noteTime+=a/this.options.beatIncrement},_checkSamples:function(){var b=this,c=a.grep(this._samples,function(a){var c=a.sample("getStartTime");return c>=b._timerCounter&&c<b._timerCounter+b.options.timerInterval||b._timerCounter<a.sample("getEndTime")&&a.sample("hasSampleStarted")});a.each(c,function(a,b){b.sample("option","sampleStarted",!0),b.sample("play")})},_loadEffects:function(){var b=a("#effectList option").length,c=this;for(var d=1;d<b;d++){var e=a("#effectList option").eq(d),f={wetMix:e.attr("data-wet"),dryMix:e.attr("data-dry"),url:e.attr("data-url"),effectType:e.val(),context:c.context};this._effects.push(e.effects(f))}},_playNote:function(a,b,c,d,e,f,g,h,i,j,k,l,m){var n=this.context.createBufferSource();n.buffer=this.isGraphical?a.audioSampleGraphical("getBuffer"):a.audioSample("getBuffer"),n.playbackRate.value=j,this.isGraphical?a.audioSampleGraphical("setBufferNode",n):a.audioSample("setBufferNode",n);var o;if(b){var p=this.context.createPanner();p.panningModel=webkitAudioPannerNode.HRTF,p.setPosition(c,d,e),p.setOrientation(-c,d,e),p.coneInnerAngle=1,p.coneOuterGain=0,n.connect(p),o=p}else o=n;if(!f)o.connect(this.masterGainNode);else{var q=this.getEffect(g),r=this.isGraphical?a.audioSampleGraphical("option","effect"):a.audioSample("option","effect"),s=q.effects("option","dryMix"),t=q.effects("option","wetMix"),u=this.isGraphical?a.audioSampleGraphical("getConvolver"):a.audioSample("getConvolver");u.connect(this.effectLevelNode);var v=this.context.createGainNode();v.gain.value=i*s,o.connect(v),v.connect(this.masterGainNode);var w=this.context.createGainNode();w.gain.value=t*r,o.connect(w),w.connect(u)}n.noteGrainOn(k,l,m)},_removeBeatsFromTrack:function(a,b,c){var d=a-b,e=this._tracks[c].splice(d,b);this._removeSamplesFromTrack(e)},_removeSamplesFromTrack:function(b){var c=a.grep(b,function(a){return a!=0});while(c.length>0){var d=c[0];this.removeSampleById(d),c=a.grep(c,function(a,b){return a!=d})}},_removeTrack:function(){this._removeTrackAtIndex(0)},_removeTrackAtIndex:function(a){this._removeSamplesFromTrack(this._tracks[a]),this._tracks.splice(a,1)},_setupTracks:function(){for(var a=0;a<this.options.tracks;a++)this._addTrack()},_stopSamples:function(){var b=this;a.each(this._samples,function(a,c){b.isGraphical?c.audioSampleGraphical("stop",b.noteTime):c.audioSample("stop",b.noteTime)})},_setOption:function(a,b){switch(a){case"numberOfLoopBeats":this.adjustNumberOfBeats(b),this.options.numberOfLoopBeats=b;break;default:this.options[a]=b}this._super("_setOption",a,b)},_waitForSamples:function(){this._toggle.text("").append('<i class="icon-refresh icon-white"></i>');var b=this,c=setInterval(function(){try{a.each(b._samples,function(a,b){b.audioSample("getBuffer")}),Mashup.EndLoading(),b.isLoaded=!0,b.play(),clearInterval(c)}catch(d){}},1e3)},addLoadedSample:function(a){this._loadedSamples.push(a)},addSample:function(a){var b=this._uniqueSampleIdentifier++;this.isGraphical?a.audioSampleGraphical("setUniqueIdentifier",b):a.audioSample("setUniqueIdentifier",b),this.addOrRemoveSampleToTrack(a,b),this._samples.push(a)},addOrRemoveSampleToTrack:function(a,b){var c=this.isGraphical?a.audioSampleGraphical("option","track"):a.audioSample("option","track"),d=this.isGraphical?a.audioSampleGraphical("getStartBeat"):a.audioSample("getStartBeat"),e=this.isGraphical?a.audioSampleGraphical("getNumberOfBeats"):a.audioSample("getNumberOfBeats"),f=this._tracks[c];for(var g=d;g<e+d;g++)f[g]=b},adjustNumberOfBeats:function(a){var b=this._tracks[0].length;if(a>b){var c=a-b;this._addBeatsToTracks(c)}else{var d=b-a;for(var e=0;e<this.options.tracks+1;e++)this._removeBeatsFromTrack(b,d,e)}},getContext:function(){return this.context},getEffect:function(b){return a.grep(this._effects,function(a){return a.effects("option","effectType")==b})[0]},getLoadedSampleById:function(b){return a.grep(this._loadedSamples,function(a){return a.id===b})[0]},getSampleByUniqueId:function(b){var c=this;return a.grep(this._samples,function(a){return c.isGraphical?a.audioSampleGraphical("getUniqueIdentifier")===b:a.audioSample("getUniqueIdentifier")===b})[0]},getTrackByIndex:function(a){return this._tracks[a]},loadMix:function(b){var c=JSON.parse(b);this.options=c.player,this.reset(),this.isLoaded=!1;var d=this;this.adjustNumberOfBeats(c.player.numberOfLoopBeats),Mashup.StartLoading(),setTimeout(function(){a.each(c.samples,function(b,c){var e=a("<div />").append("&nbsp;");a("#player").append(e);var f=e.audioSample(c);d.addSample(f)})},10),this.play()},play:function(){this.isLoaded?(this.stopped&&(this.noteTime=0,this.stopped=!1),this.startTime=this.context.currentTime-this.noteTime+.005,this._toggle.text("").append('<i class="icon-pause icon-white"></i>'),this._isPlaying=!0,this.schedule()):this._waitForSamples(),a("title").text("▶ "+a("title").text())},pause:function(){this._stopSamples(),this._toggle.text("").append('<i class="icon-play icon-white"></i>'),this._isPlaying=!1,clearTimeout(this.timeoutId),a("title").text(a("title").text().replace(/▶/g,""))},removeSampleById:function(a){var b=this.getSampleByUniqueId(a);this.addOrRemoveSampleToTrack(b,0);var c=this._samples.indexOf(b);this.removeSampleByIndex(c)},removeSampleByIndex:function(a){var b=this._samples[a];this.isGraphical?b.audioSampleGraphical("destroy"):b.audioSample("destroy"),this._samples.splice(a,1)},reset:function(){var b=this;b.stop();for(var c=this.options.tracks-1;c>=0;c--)b._removeTrackAtIndex(c);this._tracks=[],this._setupTracks(),a("#mashId").val("0"),a("#playerSave").text("Save")},schedule:function(){var a=this.context.currentTime;a-=this.startTime;while(this.noteTime<a+.2){var b=this.noteTime+this.startTime;for(var c=0;c<this._samples.length;c++){var d=this._samples[c],e=this.isGraphical?d.audioSampleGraphical("option","rhythmIndex"):d.audioSample("option","rhythmIndex");if(this.rhythmIndex===parseInt(e)){var f=this.isGraphical?d.audioSampleGraphical("getOptions"):d.audioSample("getOptions"),g=f.bpm===0?1:this.options.bpm/f.bpm,h=-5+10*f.pan,i=h!=0,j=f.effectType,k=j!==-1,l=f.trimStart,m=f.playDuration-.01,n=f.shiftSample;this._playNote(d,i,h,0,0,k,j,0,1,g,b+n,l,m)}}this._advanceNote()}this.timeoutId=this.isGraphical?setTimeout("Mashup.Player.audioPlayerGraphical('schedule')",0):setTimeout("Mashup.Player.audioPlayer('schedule')",0)},setToggle:function(b){this._toggle=a(b)},stop:function(){this.stopped=!0,this._isPlaying=!1,this._stopSamples(),this._toggle.text("").append('<i class="icon-play icon-white"></i>'),clearTimeout(this.timeoutId),this.rhythmIndex=0,this._currentBeat=0,a("title").text(a("title").text().replace(/▶/g,""))},updateLoadedSample:function(b){var c=a.grep(this._loadedSamples,function(a){return a.id===b.id})[0];c.buffer=b.buffer;if(this.isGraphical)for(var d=0;d<this._samples.length;d++)this._samples[d].audioSampleGraphical("option","id")===b.id&&this._samples[d].audioSampleGraphical("setBuffer",b.buffer);else for(var d=0;d<this._samples.length;d++)this._samples[d].audioSample("option","id")===b.id&&this._samples[d].audioSample("setBuffer",b.buffer)},_destroy:function(){this.reset(),this._samples=null,this._tracks=null,this._loadedSamples=null,this._toggle.unbind("click")}})})(jQuery,window,document)
;(function(a,b,c,d){a.widget("Mashup.audioPlayerGraphical",a.Mashup.audioPlayer,{options:{bpm:115,playButton:null,stopButton:null,clearButton:null,saveButton:null,numberOfLoopBeats:16,rhythmIndex:0,beatIncrement:4,tracks:5},_currentBeat:0,_previousBeat:0,_viewableBeats:16,_create:function(){this.isGraphical=!0,a.Mashup.audioPlayer.prototype._create.call(this);var b=this;this._stop=a(this.options.stopButton);if(this._stop.length<1)throw"Stop button does not exist";this._stop.click(function(){b.stop()}),this._save=a(this.options.saveButton);if(this._save.length<1)throw"Save button does not exist";this._save.click(function(){b.savePlayer(this)}),this._toggle=a(this.options.playButton);if(this._toggle.length<1)throw"Play button does not exist";this._toggle.click(function(){b.togglePlay()}),this._clear=a(this.options.clearButton);if(this._clear.length<1)throw"Clear button does not exist";this._clear.click(function(){b.reset()}),a("body").keydown(function(a){if(a.which===32){if(a.target.tagName.toUpperCase()==="INPUT")return;a.preventDefault(),b.togglePlay()}}),b._autoScroll=!1,a("#toggle-autoscroll").click(function(){b._autoScroll=a(this).is(":checked")}),this._setupTracks(),a(".track:last-child .span1").on("click",function(){b.pause();var c=a(".track:last-child .span1").index(this)+1;b.rhythmIndex=c*b.options.beatIncrement-1,b._drawNote(),b._advanceNote()})},_addTrack:function(){a.Mashup.audioPlayer.prototype._addTrack.call(this);var b=a("<div />").addClass("track row-fluid"),c="<div class='span1'></div>";for(var d=0;d<this.options.numberOfLoopBeats;d++)b.append(c);a(this.element[0]).append(b)},_drawNote:function(){var a=this.rhythmIndex+1;if(!(a%this.options.beatIncrement)){this._currentBeat=a/this.options.beatIncrement,this.$player.find(".track:last-child .span1:nth-child("+this._previousBeat+")").removeClass("onBeat"),this.$player.find(".track:last-child .span1:nth-child("+this._currentBeat+")").addClass("onBeat"),this._previousBeat=this._currentBeat;if(!this._autoScroll)return;var b=this,c=this.$player.find(".track:last-child .onBeat").position().left;c>this.$player.width()?(b._autoScrolling=!0,this.$player.animate({scrollLeft:$player.scrollLeft()+this.$player.width()},50)):c<0&&this.$player.animate({scrollLeft:c},50)}},_setOption:function(a,b){switch(a){case"numberOfLoopBeats":var c=this.options.numberOfLoopBeats;this.options.numberOfLoopBeats=b,this.adjustNumberOfBeats(c);break;default:this.options[a]=b}this._super("_setOption",a,b)},_setupTracks:function(){for(var b=0;b<this.options.tracks+1;b++)this._addTrack();a(this.element[0]).find('.track:not(:last-child) [class*="span"]').droppable(Mashup.properties.droppableDefaultOptions)},_trimPlayer:function(){var a=0;for(var b=0;b<this._samples.length;b++){var c=this._samples[b].audioSampleGraphical("option","rhythmIndex")/this.options.beatIncrement,d=c+this._samples[b].audioSampleGraphical("getNumberOfBeats");a=d>a?d:a}a>=this._viewableBeats&&(this.options.numberOfLoopBeats=a,this.adjustNumberOfBeats(a))},adjustNumberOfBeats:function(b){var c=this.options.numberOfLoopBeats,d=c/this._viewableBeats*100;a(".track").width(d+"%");if(c>b){var e=c-b;this._addBeatsToTracks(e);var f='<div class="span1"></div>',g='<div class="span1 measure"></div>';for(var h=0;h<e;h++)this.element.children().append(f),this.element.children(":not(:last-child)").find(":last-child").droppable(Mashup.properties.droppableDefaultOptions)}else{var i=b-c;for(var j=0;j<this.options.tracks;j++)this._removeBeatsFromTrack(b,i,j);for(var k=0;k<i;k++){var l=this.element.children().children(":last-child");a.each(l,function(b,c){a(c).remove()})}}this.correctSpanWidths()},correctSpanWidths:function(){var b=this.options.numberOfLoopBeats,c=a(this.element[0]).children(".track");for(var d=1;d<=b;d++)c.children(".span"+d).width(d/b*100+"%")},loadMix:function(b){var c=JSON.parse(b);this.options=c.player,a("#PlayerBpm").val(c.player.bpm),this.adjustNumberOfBeats(c.player.numberOfLoopBeats),Mashup.GetSamples(),Mashup.StartLoading(),setTimeout(function(){a.each(c.samples,function(a,b){var d=this.$player.children(".track:eq("+b.track+")"),e=0,f=d.children(":first-child");b.startBeat=b.rhythmIndex/c.player.beatIncrement;while(e<b.startBeat){var g=f.attr("class").match(Mashup.properties.numberRegEx);e+=parseInt(g[0]),f=f.next()}var h=f;Mashup.MoveSampleToPlayer(b,h)}),Mashup.EndLoading()},10)},play:function(){this.stopped&&this.$player.find(".track:last-child span:nth-child(0)").addClass("onBeat"),this.isLoaded=!0,a.Mashup.audioPlayer.prototype.play.call(this),this._toggle.text("Pause").append('<i class="icon-pause icon-white"></i>'),a(".player-option").attr("disabled","disabled")},pause:function(){a.Mashup.audioPlayer.prototype.pause.call(this),this._toggle.text("Play").append('<i class="icon-play icon-white"></i>'),a(".player-option").removeAttr("disabled")},savePlayer:function(c){var d=[],e=[];for(var f=0;f<this._samples.length;f++){var g=this._samples[f].audioSampleGraphical("getOptions");d.push(g),e.indexOf(g.id)<0&&e.push(g.id)}var h=this.options,i={player:h,samples:d},j=a(c);if(j.attr("data-signed-in")==="false")return a.jStorage.set("latestUserMix",JSON.stringify(i)),a.jStorage.set("latestSampleIds",e),b.location.href="/Account/Logon?continue="+escape("/Home&saveMix=true"),!1;a("#MashupJson").val(JSON.stringify(i)),a("#SampleIds").val(e);if(a("#mashId").val()==="0")a("#saveModal").modal("show");else{var k=a("#SampleIds").val().split(",");Mashup.StartLoading("Updating Mashup....");var l={Id:a("#mashId").val(),MashupJson:a("#MashupJson").val(),SampleIds:k},m="/api/mashups?format=json";a.ajax({type:"PUT",data:l,url:m,traditional:!0,success:function(){a("#selectedTags").empty(),a("#hiddenTags").empty(),Mashup.EndLoading(),Mashup.ShowMessage("Success","Your mash was updated.",Mashup.properties.messageType.Success)},error:Mashup.GenericErrorMessage})}},schedule:function(){this._drawNote(),a.Mashup.audioPlayer.prototype.schedule.call(this)},stop:function(){a.Mashup.audioPlayer.prototype.stop.call(this),a(".player-option").removeAttr("disabled"),this._toggle.text("Play").append('<i class="icon-play icon-white"></i>')},togglePlay:function(){this._toggle.children("i").hasClass("icon-pause")?this.pause():this.play()},_destroy:function(){this._samples=null,this._tracks=null,this._toggle.unbind("click"),this._stop.unbind("click"),this._clear.unbind("click"),this._save.unbind("click"),a("body").unbind("keydown")}})})(jQuery,window,document)
;(function(a,b,c,d){a.widget("Mashup.audioSample",{options:{loop:!1,fileName:null,sampleName:null,artist:null,bpm:88,id:0,rhythmIndex:0,track:0,mono:!1,duration:0,volume:.4096,pan:.5,effectType:-1,effect:.5,trimStart:0,shiftSample:0,playDuration:0},isGraphical:!1,_trimEnd:0,sampleUniqueId:0,_create:function(){this._calculateStartBeat(),this._calculateNumberOfBeats(),this._loadSample(),this.convolver=this.isGraphical?Mashup.Player.audioPlayerGraphical("getContext").createConvolver():Mashup.Player.audioPlayer("getContext").createConvolver()},_calculateStartBeat:function(){var a=this.isGraphical?Mashup.Player.audioPlayerGraphical("option","beatIncrement"):Mashup.Player.audioPlayer("option","beatIncrement");this.startBeat=Math.round(this.options.rhythmIndex/a)},_calculateNumberOfBeats:function(){this.numberOfBeats=Math.round(this.options.bpm/60*this.options.playDuration),this.numberOfBeats===0&&(this.numberOfBeats=1)},_calculateTempo:function(){this.options.bpm=this.numberOfBeats/this.options.duration*60},_loadSample:function(){var b=this.isGraphical?Mashup.Player.audioPlayerGraphical("getLoadedSampleById",this.options.id):Mashup.Player.audioPlayer("getLoadedSampleById",this.options.id);if(typeof b.buffer!="undefined"){this.buffer=b.buffer;return}if(typeof b.id!="undefined")return;var c={id:this.options.id};this.isGraphical?Mashup.Player.audioPlayerGraphical("addLoadedSample",c):Mashup.Player.audioPlayer("addLoadedSample",c);var d,e=this;if(!this.options.fileName){var f=a(this.options.waveFormElement).audioViewer("getFinalSampleBuffer"),g=new Blob([btoa(f)],{type:"audio/wav"}),h=new FileReader;h.onload=function(){var a=this.result;try{e.buffer=Mashup.Player.audioPlayerGraphical("getContext").createBuffer(a,e.options.mono)}catch(b){Mashup.ShowMessage("Schnikes!",b)}},h.readAsArrayBuffer(g);return}d=Mashup.properties.sampleFilePath+this.options.fileName;var i=new XMLHttpRequest;i.open("GET",d,!0),i.responseType="arraybuffer",i.onload=function(){e.buffer=e.isGraphical?Mashup.Player.audioPlayerGraphical("getContext").createBuffer(i.response,e.options.mono):Mashup.Player.audioPlayer("getContext").createBuffer(i.response,e.options.mono),e.buffer.gain=e.options.volume,c={id:e.options.id,buffer:e.buffer},e.isGraphical?Mashup.Player.audioPlayerGraphical("updateLoadedSample",c):Mashup.Player.audioPlayer("updateLoadedSample",c)},i.send()},_setOption:function(a,b){switch(a){case"volume":b=Math.pow(b,4),this.options.volume=b,this.buffer!==null&&(this.buffer.gain=b);break;default:this.options[a]=b}this._super("_setOption",a,b)},getBuffer:function(){return this.buffer},getConvolver:function(){return this.convolver},getNumberOfBeats:function(){return this.numberOfBeats},getStartBeat:function(){return this.startBeat},getOptions:function(){return this.options},getUniqueIdentifier:function(){return this.sampleUniqueId},setBuffer:function(a){this.buffer=a,this.buffer.gain=this.options.volume},setBufferNode:function(a){this.bufferNode=a},setUniqueIdentifier:function(a){this.sampleUniqueId=a},stop:function(a){this.bufferNode!=null&&this.bufferNode.noteOff(a)},_destroy:function(){}})})(jQuery,window,document)
;(function(a,b,c,d){a.widget("Mashup.audioSampleGraphical",a.Mashup.audioSample,{options:{fileName:null,sampleName:null,artist:null,bpm:88,id:0,rhythmIndex:0,track:0,mono:!1,duration:0,volume:.4096,pan:.5,effectType:-1,effect:.5,trimStart:0,shiftSample:0,playDuration:0},_initiated:!1,$sampleContainer:null,_create:function(){this.isGraphical=!0,this._calculateStartBeat(),this._calculateNumberOfBeats(),this._animate(),a.Mashup.audioSample.prototype._create.call(this),this._handleEvents(),this._loadEffect(),this._initiated=!0},_animate:function(){this._makeTrackRoom(),this.$sampleContainer=a("<div />").append("<span id='"+this.options.id+"'>"+this.options.sampleName+"</span><a class='icon-remove icon-white pull-right'></a>").addClass("sample").attr("data-sample-options",JSON.stringify(this.options)),this.$sampleContainer.draggable(Mashup.properties.draggableDefaultOptions);var b=this.$sampleContainer;this.element.append(this.$sampleContainer).fadeIn(function(){b.animate({width:"100%",height:"30px"})})},_loadEffect:function(){if(this.options.effectType===-1)return;var a=Mashup.Player.audioPlayerGraphical("getEffect",this.options.effectType);this.convolver.buffer=a.effects("getBuffer")},_handleEvents:function(){this.$sampleContainer.find(".icon-remove").click(function(){Mashup.Player.audioPlayerGraphical("removeSampleById",a.sampleUniqueId)});var a=this;this.$sampleContainer.click(function(){a.showControls()})},_makeTrackRoom:function(){var b=Mashup.Player.audioPlayerGraphical("option","numberOfLoopBeats");if(this.startBeat+this.numberOfBeats>=b){var c=Math.ceil((this.startBeat+this.numberOfBeats+1)/4);b=c*4,Mashup.Player.audioPlayerGraphical("option","numberOfLoopBeats",b)}var d=Mashup.Player.audioPlayerGraphical("getTrackByIndex",this.options.track);for(var e=this.startBeat;e<this.startBeat+this.numberOfBeats;e++)if(d[e]!==0)throw"The sample overlaps another sample on the same track.";for(var f=0;f<this.numberOfBeats-1;f++)this.element.next().remove();this.element.removeClass("span1"),this.element.addClass("span"+this.numberOfBeats);var g=this.numberOfBeats/b*100;return a(".track .span"+this.numberOfBeats).width(g+"%"),!0},_restoreTrackRoom:function(){this.element.removeClass("span"+this.numberOfBeats);var a=100/Mashup.Player.audioPlayerGraphical("option","numberOfLoopBeats");this.element.addClass("span1").droppable(Mashup.properties.droppableDefaultOptions).css("width",a+"%");var b="<div class='span1' style='width:"+a+"%'></div>";console.log(b);var c=this.startBeat,d=this.element,e;for(var f=0;f<this.numberOfBeats-1;f++)e=b,d.after(e),d=d.next();this.element.parent().children(".span1").droppable(Mashup.properties.droppableDefaultOptions)},_updateOptionsOnPlayer:function(){var a=JSON.stringify(this.options);this.$sampleContainer.attr("data-sample-options",a)},_setOption:function(a,b){switch(a){case"volume":b=Math.pow(b,4),this.options.volume=b,this.buffer!==null&&(this.buffer.gain=b),this._updateOptionsOnPlayer();break;default:this.options[a]=b,this._updateOptionsOnPlayer()}this._super("_setOption",a,b)},getInitiated:function(){return this._initiated},hideControls:function(){a("#sampleSugar").slideUp(500),Mashup.Player.find(".sample").removeClass("edit")},play:function(a){this.$sampleContainer.addClass("playing")},showControls:function(){if(this.$sampleContainer.hasClass("edit")){this.hideControls();return}var b=a("#sampleSugar");Mashup.Player.find(".sample").removeClass("edit"),this.$sampleContainer.addClass("edit"),b.is(":visible")||b.slideDown(500),a("#purchaseSong").hide(),a.ajax({url:"/api/samples/"+this.options.id+"?format=json",success:function(b){b.Sample.BuyLink&&(a("#purchaseSong").attr("href",b.Sample.BuyLink),a("#purchaseSong").show())},error:Mashup.GenericErrorMessage}),a("#sampleArtist").text(this.options.artist),a("#sampleName").text(this.options.sampleName),a("#sampleBpm").text(this.options.bpm),a("#sampleBeats").text(this.numberOfBeats+" beats");var c=b.find(".slider-thumb"),d=this;a.each(c,function(b,c){var e=a(c).audioControl("option","sliderThumbId");e==="volume"?a(c).audioControl("sliderSetPosition",Math.pow(d.options[e],.25)):a(c).audioControl("sliderSetPosition",d.options[e])}),a(".slider-thumb").audioControl("option","sample",d.element),a("#effectList").unbind("change"),a("#shiftSample").unbind("change"),a("#effectList").val(d.options.effectType),a("#effectList").change(function(){d.options.effectType=parseInt(a(this).val()),d._updateOptionsOnPlayer(),d._loadEffect()});var e=Mashup.Player.audioPlayerGraphical("option","bpm")/60;a("#shiftSample").val(Math.round(d.options.shiftSample*e*16)),a("#shiftSample").change(function(){d.options.shiftSample=a(this).val()/(e*16),d._updateOptionsOnPlayer()}),a("#sampleLengthEdit").length>0&&(a("#sampleLengthEdit").remove(),a("#sampleEdit i").removeClass("icon-file"),a("#sampleEdit i").addClass("icon-edit"))},_destroy:function(){this._initiated?(this.$sampleContainer.draggable("destroy"),this.$sampleContainer.remove(),this._restoreTrackRoom()):this.element.droppable(Mashup.properties.droppableDefaultOptions)}})})(jQuery,window,document)
;(function(a,b,c,d){a.widget("Mashup.audioPlayerWaveformViewer",a.Mashup.audioPlayer,{options:{waveformStart:0,waveformEnd:0},_advanceLoop:function(){this.noteTime+=this.duration},_create:function(){this.isGraphical=!1,a.Mashup.audioPlayer.prototype._create.call(this)},_playNote:function(a,b,c){this.source=this.context.createBufferSource(),this.buffer.gain=.4096,this.source.buffer=this.buffer;var d=this.source;d.connect(this.masterGainNode),this.source.noteGrainOn(a,b,c)},_setOption:function(a,b){switch(a){default:this.options[a]=b}this._super("_setOption",a,b)},addSample:function(a){this.buffer=a},play:function(){this.isLoaded=!0,this.noteTime=0,this.startTime=this.context.currentTime-this.noteTime+.005,this.duration=this.options.waveformEnd-this.options.waveformStart,this.schedule()},schedule:function(){var b=this.context.currentTime;b-=this.startTime;if(b<this.noteTime+this.duration&&b>this.noteTime){var c=this.noteTime+this.startTime,d=this.options.waveformStart;this._playNote(c,d,this.duration-.01),this._advanceLoop()}this.timeoutId=setTimeout("$('#"+a(this.element[0]).attr("id")+"').audioPlayerWaveformViewer('schedule')",0)},stop:function(){this.source.noteOff(0),clearTimeout(this.timeoutId)},_destroy:function(){}})})(jQuery,window,document)
;(function(a,b,c,d){a.widget("Mashup.audioViewer",{options:{width:null,height:null,sampleRate:48e3,playButton:null,zoomInButton:null,zoomOutButton:null,dropFileBox:null,audioPlayer:null},_create:function(){var b=this;this.options.width=this.options.width?this.options.width:a(this.element[0]).width(),this.options.height=this.options.height?this.options.height:a(this.element[0]).height();var d=a(this.options.audioPlayer);this.$audioPlayer=d.audioPlayerWaveformViewer(),Mashup.Player&&a("body").keydown(function(a){if(a.which===32){if(a.target.tagName.toUpperCase()==="INPUT")return;a.preventDefault(),b.togglePlay()}}),this.$playBtn=a(this.options.playButton),this.$playBtn.click(function(){b.togglePlay()}),this.$zoomInBtn=a(this.options.zoomInButton),this.$zoomInBtn.click(function(){b._isSelected()?(b.endWaveform=b._getSelectedWaveformEnd(),b.startWaveform=b._getSelectedWaveformStart(),b.processWave.zoomInSelected(b.startWaveform,b.endWaveform)):b.processWave.zoomIn(),b._setWaveformData(),b.processTrim.clear()}),this.$zoomOutBtn=a(this.options.zoomOutButton),this.$zoomOutBtn.click(function(){var a=b._isSelected();b._setViewerData(a),b.processWave.zoomOut(),b._setWaveformData();if(a){var c=Math.floor((b.playWaveformStart-b.startWaveform)/(b.endWaveform-b.startWaveform)*b.options.width),d=Math.floor((b.playWaveformEnd-b.startWaveform)/(b.endWaveform-b.startWaveform)*b.options.width);b.processTrim.setTrim(c,d)}});if(this.options.dropFileBox){var e=this.options.dropFileBox.replace("#","");this._dropBox=c.getElementById(e),this._dropBox.addEventListener("drop",function(a){b.drop(a)},!1),this._dropBox.addEventListener("dragover",function(a){b.dragEnter(a)},!1),this._dropBox.addEventListener("dragleave",function(a){b.dragLeave(a)},!1)}var f=setInterval(function(){b.processTrim=Processing.getInstanceById("sampleTrim"),b.processWave=Processing.getInstanceById("sampleWaveform"),b.processPlay=Processing.getInstanceById("samplePlayIndex"),b.processTrim&&b.processWave&&b.processPlay&&(clearInterval(f),b.processWave.setSize(b.options.width,b.options.height),b.processTrim.setSize(b.options.width,b.options.height),b.processPlay.setSize(b.options.width,b.options.height))},500)},_isSelected:function(){return this.processTrim.isSelected()},_getSelectedWaveformStart:function(){return Math.floor(this.totalWaveformLength*(this.processTrim.getMin()/this.options.width)*this.waveformFraction)+this.startWaveform},_getSelectedWaveformEnd:function(){return Math.floor(this.totalWaveformLength*(this.processTrim.getMax()/this.options.width)*this.waveformFraction)+this.startWaveform},_setWaveformData:function(){this.startWaveform=this.processWave.getWaveformStart(),this.endWaveform=this.processWave.getWaveformEnd(),this.waveformFraction=(this.endWaveform-this.startWaveform)/this.totalWaveformLength},_setViewerData:function(a){this.viewerWaveformLength=this.endWaveform-this.startWaveform,this.playWaveformStart=this.startWaveform,this.playWaveformLength=this.viewerWaveformLength,this.playWaveformEnd=this.startWaveform+this.viewerWaveformLength,a&&(this.playWaveformEnd=this._getSelectedWaveformEnd(),this.playWaveformStart=this._getSelectedWaveformStart(),this.playWaveformLength=this.playWaveformEnd-this.playWaveformStart)},_setOption:function(a,b){switch(a){default:this.options[a]=b}this._super("_setOption",a,b)},_setupPlayerandPlotWaveform:function(a){var b;typeof a=="undefined"?b=this.buffer.getChannelData(0):b=a,this.startWaveform=0,this.endWaveform=b.length,this.$audioPlayer.audioPlayerWaveformViewer("addSample",this.buffer),this.$audioPlayer.audioPlayerWaveformViewer("option","waveformStart",this.startWaveform),this.$audioPlayer.audioPlayerWaveformViewer("option","waveformEnd",this.duration),this.totalWaveformLength=b.length,this.waveformFraction=1,this.processWave.addSample(b,this.endWaveform),this.processTrim.clear()},calculateBpm:function(a){var b=this.getEndTime()-this.getStartTime();return a/b*60},clear:function(){this.processWave.clear()},drop:function(c){c.stopPropagation(),c.preventDefault(),Mashup.StartLoading("Loading and drawing song...."),a(c.target).removeClass("over");var e=c.dataTransfer.files,f=this;if(e.length>0)if(b.FormData!==d){var g=e[0];if(g.type!=="audio/mp3"&&g.type!=="audio/ogg"&&g.type!=="audio/wav"){Mashup.ShowMessage("Invalid File Type","File must be an .mp3, .ogg, or .wav file",Mashup.properties.messageType.Error),Mashup.EndLoading();return}var h=new FileReader;h.onloadend=function(b){a("#dropInfo").length>0&&a("#dropInfo").remove(),a("#audioViewerControls").length>0&&a("#audioViewerControls").show(),Mashup.EndLoading(),f.loadSampleFromArrayBuffer(this.result)},h.readAsArrayBuffer(g)}else Mashup.ShowMessage("D'oh!",'This application requires a File API enabled browser.  Please download <a href="http://www.google.com/chrome" title="chrome" target="_blank">Chrome</a> to take part in the fun! (Trust me, its quick, painless and well worth it)'),Mashup.EndLoading()},dragEnter:function(b){return b.stopPropagation(),b.preventDefault(),b.dataTransfer.files.length>0&&(b.dataTransfer.dropEffect="drop"),a(b.target).addClass("over"),!1},dragLeave:function(b){return b.stopPropagation(),b.preventDefault(),a(b.target).removeClass("over"),!1},getStartTime:function(a){if(this._isSelected()||a){var b=this.startWaveform/this.totalWaveformLength*this.duration;return this.processTrim.getMin()/this.options.width*this.duration*this.waveformFraction+b}return this.startWaveform/this.totalWaveformLength*this.duration},getEndTime:function(a){if(this._isSelected()||a){var b=this.startWaveform/this.totalWaveformLength*this.duration;return this.processTrim.getMax()/this.options.width*this.duration*this.waveformFraction+b}return this.endWaveform/this.totalWaveformLength*this.duration},getSampleBuffer:function(){return this.buffer.getChannelData(0)},getFinalSampleBuffer:function(){if(this.buffer===null)throw"You must load a song by dropping song on player";this._setViewerData(this._isSelected());var a=this.playWaveformStart*4,b=this.playWaveformEnd*4,c=b-a;if(c>Mashup.properties.maxSampleLength)throw"Sample is too long.  Please keep sample under 90 seconds";var d=this.normalizeSample(),e=PCMData.encode({data:d,sampleRate:44100,channelCount:2,bytesPerSample:2});return e},isPlaying:function(){return!this.$playBtn.children("i").hasClass("icon-play")},loadSampleFromArrayBuffer:function(a){this.buffer=this.$audioPlayer.audioPlayerWaveformViewer("getContext").createBuffer(a,!1),this.duration=this.buffer.duration,this._setupPlayerandPlotWaveform()},loadSampleFromFileUrl:function(a,b,c){this.id=b,this.duration=c;var d=Mashup.Player.audioPlayerGraphical("getLoadedSampleById",this.id);if(typeof d.buffer!="undefined"){this.buffer=d.buffer,this._setupPlayerandPlotWaveform();return}var e=this,f=Mashup.properties.sampleFilePath+a,g=new XMLHttpRequest;g.open("GET",f,!0),g.responseType="arraybuffer",g.onload=function(){e.loadSampleFromArrayBuffer(g.response)},g.send()},normalizeSample:function(){var a=new Float32Array(this.buffer.getChannelData(0).buffer),b=2500,c=0,d=Math.floor((this.playWaveformEnd-this.playWaveformStart)/b);for(var e=this.playWaveformStart;e<this.playWaveformEnd;e+=d)a[e]>c&&(c=a[e]);var f=.7/c,g=new Float32Array(this.playWaveformEnd-this.playWaveformStart);for(var h=this.playWaveformStart;h<this.playWaveformEnd;h++)g[h-this.playWaveformStart]=a[h]*f;return g},movePlayIndicator:function(){var a=this.getStartTime(!0),b=this.getEndTime(!0);this.$audioPlayer.audioPlayerWaveformViewer("option","waveformStart",a),this.$audioPlayer.audioPlayerWaveformViewer("option","waveformEnd",b),this._setViewerData(!0),this.processPlay.setupPlay(this.viewerWaveformLength,this.playWaveformStart-this.startWaveform,this.playWaveformLength,this.options.sampleRate)},play:function(){this.$playBtn.children("i").removeClass("icon-play").addClass("icon-stop"),this.movePlayIndicator(),this.processPlay.play(),this.$audioPlayer.audioPlayerWaveformViewer("play"),this.$zoomInBtn.attr("disabled","disabled"),this.$zoomOutBtn.attr("disabled","disabled"),a("title").text("▶ "+a("title").text())},stop:function(){this.$playBtn.children("i").removeClass("icon-stop").addClass("icon-play"),this.processPlay.stop(),this.$audioPlayer.audioPlayerWaveformViewer("stop"),this.$zoomInBtn.removeAttr("disabled"),this.$zoomOutBtn.removeAttr("disabled"),a("title").text(a("title").text().replace(/▶/g,""))},togglePlay:function(){this.isPlaying()?this.stop():this.play()},_destroy:function(){this.$playBtn.unbind("click"),this.$zoomInBtn.unbind("click"),this.$zoomOutBtn.unbind("click"),this._dropBox.removeEventListener("drop"),this._dropBox.removeEventListener("dragover"),this._dropBox.removeEventListener("dragleave")}})})(jQuery,window,document)
;(function(a,b,c,d){a.widget("Mashup.effects",{options:{url:"",context:null,startedLoading:!1,isLoaded:!1,wetMix:0,dryMix:0},buffer:null,_create:function(){if(this.options.startedLoading)return;this.options.startedLoading=!0,this.load()},_setOption:function(a,b){switch(a){case"someValue":break;default:}this._super("_setOption",a,b)},getBuffer:function(){return this.buffer},load:function(){var a=new XMLHttpRequest;a.open("GET",this.options.url,!0),a.responseType="arraybuffer",this.request=a;var b=this;a.onload=function(){b.buffer=b.options.context.createBuffer(a.response,!1),b.options.isLoaded=!0},a.send()},_destroy:function(){}})})(jQuery,window,document)
;window.Mashup=window.Mashup||{},_.templateSettings.interpolate=/\{\{(.+?)\}\}/g,Mashup.properties={bpmDelta:2,draggableDefaultOptions:{revert:"invalid",cursorAt:{left:85},helper:function(a){var b=$(this).clone();b.children("button").remove(),b.removeClass("highlight");var c=$("<li />").append(b).addClass("sampleSelected");return c}},droppableDefaultOptions:{accept:".sampleList li, .sample, #waveformSample",hoverClass:"hover",drop:function(a,b){var c=$(this),d=$(b.draggable.context).attr("data-sample-options"),e=JSON.parse(d);e.track=Mashup.GetTrack(c),e.rhythmIndex=Mashup.GetStartBeat(c);if($(b.draggable.context).attr("data-waveform")){e.playDuration=$("#sampleWaveform").audioViewer("getEndTime")-$("#sampleWaveform").audioViewer("getStartTime"),e.trimStart=0,e.id=(new Date).getTime(),e.waveFormElement="#sampleWaveform",Mashup.MoveSampleToPlayer(e,c);return}typeof e.playDuration=="undefined"&&(e.playDuration=e.duration),Mashup.MoveSampleToPlayer(e,c)}},maxSampleLength:15876e3,mouseCaptureOffset:0,mouseCapture:null,currentSlider:null,messageType:{Warning:"",Success:"alert-success",Error:"alert-error"},numberRegEx:/(\d{1,5})/},Mashup.Player={},Mashup.ShowMessage=function(a,b,c,d){Mashup.EndLoading(),c=typeof c=="undefined"?Mashup.properties.messageType.Warning:c;var e={Title:a,Message:b,AlertType:c},f=$("#mashup-message-template").html();typeof d=="undefined"&&(d="#main-content"),$(d).prepend(_.template(f,e))},Mashup.GenericErrorMessage=function(a,b,c){Mashup.EndLoading(),$(".modal").modal("hide");switch(a.status){case 400:var d=JSON.parse(a.responseText);return Mashup.ShowMessage("Not so fast",d.ResponseStatus.Message,Mashup.properties.messageType.Error),!1;case 401:return Mashup.ShowMessage("Unauthorized","You must be logged in to complete this action. Log in <a href='/Account/LogOn/' title='Log In' >here</a>",Mashup.properties.messageType.Warning),!1;default:var e=JSON.parse(a.responseText);if(e.ResponseStatus.ErrorCode=="BusinessServicesException")return Mashup.ShowMessage("Dang!",e.ResponseStatus.Message,Mashup.properties.messageType.Error),!1;return Mashup.ShowMessage("What the!","Sorry, we could not process your request.  The error has been logged and we will do our best to correct the error asap.",Mashup.properties.messageType.Error),!1}},Mashup.MoveSampleToPlayer=function(a,b){b.droppable("destroy");try{var c=b.audioSampleGraphical(a);Mashup.Player.audioPlayerGraphical("addSample",c)}catch(d){c&&c.audioSampleGraphical("destroy"),Mashup.ShowMessage("Schnikes!",d)}},Mashup.GetTrack=function(a){var b=a.parent();return $(".player").find(".track").index(b)},Mashup.GetStartBeat=function(a){var b=a.parent(),c=b.find('[class*="span"]').index(a),d=0,e=0,f=b.find(":first-child");while(e!=c)d+=f.outerWidth(),f=f.next(),e++;var g=Mashup.Player.audioPlayerGraphical("option","numberOfLoopBeats"),h=Mashup.Player.audioPlayerGraphical("option","beatIncrement"),i=b.width();return Math.round(d/i*g*h)},Mashup.GetSamples=function(){var a="/api/samples?format=json",b=$("#selectedSampleTags"),c=$("#PlayerBpm").val();Mashup.StartLoading("Loading samples...");var d=b.children(".artistId"),e=b.children(".tagId"),f=[],g=[];for(var h=0;h<d.length;h++)f.push(d.eq(h).attr("data-id"));for(var i=0;i<e.length;i++)g.push(e.eq(i).attr("data-id"));var j={Bpm:c,ArtistIds:f,TagIds:g,PageIndex:$("#pageIndex").val(),PageSize:$("#pageSize").val()};$.ajax({url:a,data:j,type:"POST",traditional:!0,success:function(a,b,c){var d=_.template($("#mashup-songlist-template").html()),e=$("#samples");return e.empty(),_.each(a.SampleList,function(a){e.append(d(a))}),$("#samplesAdded").val(a.SamplesAdded),e.children("li").draggable(Mashup.properties.draggableDefaultOptions),Mashup.AdjustPagers(),Mashup.EndLoading(),!1},error:Mashup.GenericErrorMessage})},Mashup.AdjustPagers=function(){var a=parseInt($("#pageIndex").val()),b=parseInt($("#pageSize").val()),c=parseInt($("#samplesAdded").val()),d=$("#samples li").length;if(a===0&&c>0){$(".next").hide();if(d===b){$(".previous").show();return}$(".previous").hide();return}a<=0&&d<b?$(".previous").hide():$(".previous").show(),a>=0&&d<b?$(".next").hide():$(".next").show()},Mashup.StartLoading=function(a){var b="Loading...Please Wait";typeof a!="undefined"&&(b=a),$("#loading span").text(b),$("#loading").show(),$("body").css("cursor","wait")},Mashup.EndLoading=function(){$("#loading").hide(),$("body").css("cursor","default")},Mashup.GetParameterByName=function(a){var b=RegExp("[?&]"+a+"=([^&]*)").exec(window.location.search);return b&&decodeURIComponent(b[1].replace(/\+/g," "))},Mashup.webAudioApi=function(){return!window.webkitAudioContext&&!window.AudioContext},Mashup.isFloat=function(a){return a===+a&&a!==(a|0)},Mashup.GetFormInput=function(a){var b={};return $.each($("#"+a).serializeArray(),function(a,c){c.name.indexOf(".")>=0&&(c.name=c.name.substring(c.name.indexOf(".")+1,c.name.length)),b[c.name]=c.value}),b}
;(function(a,b,c,d){a.widget("Mashup.myResizable",a.ui.mouse,{options:{resizeElement:null},_create:function(){this._mouseInit()},_mouseStart:function(a){this.originalMousePosition=a.pageY,this.orginalResizeHeight=this.options.resizeElement.height(),this.originalTop=parseInt(this.element.css("top").replace("px",""))},_mouseDrag:function(a){var b=this.originalMousePosition-a.pageY;this.options.resizeElement.height(this.orginalResizeHeight-b),this.element.css("top",this.originalTop-b)},_setOption:function(a,b){switch(a){case"someValue":break;default:}this._super("_setOption",a,b)},_destroy:function(){}})})(jQuery,window,document)
