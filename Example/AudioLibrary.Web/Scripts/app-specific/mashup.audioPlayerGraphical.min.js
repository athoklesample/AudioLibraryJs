(function(a,b,c,d){a.widget("Mashup.audioPlayerGraphical",a.Mashup.audioPlayer,{options:{bpm:115,playButton:null,stopButton:null,clearButton:null,saveButton:null,numberOfLoopBeats:16,rhythmIndex:0,beatIncrement:4,tracks:5},_currentBeat:0,_previousBeat:0,_viewableBeats:16,_create:function(){this.isGraphical=!0,a.Mashup.audioPlayer.prototype._create.call(this);var b=this;this._stop=a(this.options.stopButton);if(this._stop.length<1)throw"Stop button does not exist";this._stop.click(function(){b.stop()}),this._save=a(this.options.saveButton);if(this._save.length<1)throw"Save button does not exist";this._save.click(function(){b.savePlayer(this)}),this._toggle=a(this.options.playButton);if(this._toggle.length<1)throw"Play button does not exist";this._toggle.click(function(){b.togglePlay()}),this._clear=a(this.options.clearButton);if(this._clear.length<1)throw"Clear button does not exist";this._clear.click(function(){b.reset()}),a("body").keydown(function(a){if(a.which===32){if(a.target.tagName.toUpperCase()==="INPUT")return;a.preventDefault(),b.togglePlay()}}),b._autoScroll=!1,a("#toggle-autoscroll").click(function(){b._autoScroll=a(this).is(":checked")}),this._setupTracks(),a(".track:last-child .span1").on("click",function(){b.pause();var c=a(".track:last-child .span1").index(this)+1;b.rhythmIndex=c*b.options.beatIncrement-1,b._drawNote(),b._advanceNote()})},_addTrack:function(){a.Mashup.audioPlayer.prototype._addTrack.call(this);var b=a("<div />").addClass("track row-fluid"),c="<div class='span1'></div>";for(var d=0;d<this.options.numberOfLoopBeats;d++)b.append(c);a(this.element[0]).append(b)},_drawNote:function(){var a=this.rhythmIndex+1;if(!(a%this.options.beatIncrement)){this._currentBeat=a/this.options.beatIncrement,this.$player.find(".track:last-child .span1:nth-child("+this._previousBeat+")").removeClass("onBeat"),this.$player.find(".track:last-child .span1:nth-child("+this._currentBeat+")").addClass("onBeat"),this._previousBeat=this._currentBeat;if(!this._autoScroll)return;var b=this,c=this.$player.find(".track:last-child .onBeat").position().left;c>this.$player.width()?(b._autoScrolling=!0,this.$player.animate({scrollLeft:$player.scrollLeft()+this.$player.width()},50)):c<0&&this.$player.animate({scrollLeft:c},50)}},_setOption:function(a,b){switch(a){case"numberOfLoopBeats":var c=this.options.numberOfLoopBeats;this.options.numberOfLoopBeats=b,this.adjustNumberOfBeats(c);break;default:this.options[a]=b}this._super("_setOption",a,b)},_setupTracks:function(){for(var b=0;b<this.options.tracks+1;b++)this._addTrack();a(this.element[0]).find('.track:not(:last-child) [class*="span"]').droppable(Mashup.properties.droppableDefaultOptions)},_trimPlayer:function(){var a=0;for(var b=0;b<this._samples.length;b++){var c=this._samples[b].audioSampleGraphical("option","rhythmIndex")/this.options.beatIncrement,d=c+this._samples[b].audioSampleGraphical("getNumberOfBeats");a=d>a?d:a}a>=this._viewableBeats&&(this.options.numberOfLoopBeats=a,this.adjustNumberOfBeats(a))},adjustNumberOfBeats:function(b){var c=this.options.numberOfLoopBeats,d=c/this._viewableBeats*100;a(".track").width(d+"%");if(c>b){var e=c-b;this._addBeatsToTracks(e);var f='<div class="span1"></div>',g='<div class="span1 measure"></div>';for(var h=0;h<e;h++)this.element.children().append(f),this.element.children(":not(:last-child)").find(":last-child").droppable(Mashup.properties.droppableDefaultOptions)}else{var i=b-c;for(var j=0;j<this.options.tracks;j++)this._removeBeatsFromTrack(b,i,j);for(var k=0;k<i;k++){var l=this.element.children().children(":last-child");a.each(l,function(b,c){a(c).remove()})}}this.correctSpanWidths()},correctSpanWidths:function(){var b=this.options.numberOfLoopBeats,c=a(this.element[0]).children(".track");for(var d=1;d<=b;d++)c.children(".span"+d).width(d/b*100+"%")},loadMix:function(b){var c=JSON.parse(b);this.options=c.player,a("#PlayerBpm").val(c.player.bpm),this.adjustNumberOfBeats(c.player.numberOfLoopBeats),Mashup.GetSamples(),Mashup.StartLoading(),setTimeout(function(){a.each(c.samples,function(a,b){var d=this.$player.children(".track:eq("+b.track+")"),e=0,f=d.children(":first-child");b.startBeat=b.rhythmIndex/c.player.beatIncrement;while(e<b.startBeat){var g=f.attr("class").match(Mashup.properties.numberRegEx);e+=parseInt(g[0]),f=f.next()}var h=f;Mashup.MoveSampleToPlayer(b,h)}),Mashup.EndLoading()},10)},play:function(){this.stopped&&this.$player.find(".track:last-child span:nth-child(0)").addClass("onBeat"),this.isLoaded=!0,a.Mashup.audioPlayer.prototype.play.call(this),this._toggle.text("Pause").append('<i class="icon-pause icon-white"></i>'),a(".player-option").attr("disabled","disabled")},pause:function(){a.Mashup.audioPlayer.prototype.pause.call(this),this._toggle.text("Play").append('<i class="icon-play icon-white"></i>'),a(".player-option").removeAttr("disabled")},savePlayer:function(c){var d=[],e=[];for(var f=0;f<this._samples.length;f++){var g=this._samples[f].audioSampleGraphical("getOptions");d.push(g),e.indexOf(g.id)<0&&e.push(g.id)}var h=this.options,i={player:h,samples:d},j=a(c);if(j.attr("data-signed-in")==="false")return a.jStorage.set("latestUserMix",JSON.stringify(i)),a.jStorage.set("latestSampleIds",e),b.location.href="/Account/Logon?continue="+escape("/Home&saveMix=true"),!1;a("#MashupJson").val(JSON.stringify(i)),a("#SampleIds").val(e);if(a("#mashId").val()==="0")a("#saveModal").modal("show");else{var k=a("#SampleIds").val().split(",");Mashup.StartLoading("Updating Mashup....");var l={Id:a("#mashId").val(),MashupJson:a("#MashupJson").val(),SampleIds:k},m="/api/mashups?format=json";a.ajax({type:"PUT",data:l,url:m,traditional:!0,success:function(){a("#selectedTags").empty(),a("#hiddenTags").empty(),Mashup.EndLoading(),Mashup.ShowMessage("Success","Your mash was updated.",Mashup.properties.messageType.Success)},error:Mashup.GenericErrorMessage})}},schedule:function(){this._drawNote(),a.Mashup.audioPlayer.prototype.schedule.call(this)},stop:function(){a.Mashup.audioPlayer.prototype.stop.call(this),a(".player-option").removeAttr("disabled"),this._toggle.text("Play").append('<i class="icon-play icon-white"></i>')},togglePlay:function(){this._toggle.children("i").hasClass("icon-pause")?this.pause():this.play()},_destroy:function(){this._samples=null,this._tracks=null,this._toggle.unbind("click"),this._stop.unbind("click"),this._clear.unbind("click"),this._save.unbind("click"),a("body").unbind("keydown")}})})(jQuery,window,document)