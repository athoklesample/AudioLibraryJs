(function(a,b,c,d){a.widget("Mashup.audioSampleGraphical",a.Mashup.audioSample,{options:{fileName:null,sampleName:null,artist:null,bpm:88,id:0,rhythmIndex:0,track:0,mono:!1,duration:0,volume:.4096,pan:.5,effectType:-1,effect:.5,trimStart:0,shiftSample:0,playDuration:0},_initiated:!1,$sampleContainer:null,_create:function(){this.isGraphical=!0,this._calculateStartBeat(),this._calculateNumberOfBeats(),this._animate(),a.Mashup.audioSample.prototype._create.call(this),this._handleEvents(),this._loadEffect(),this._initiated=!0},_animate:function(){this._makeTrackRoom(),this.$sampleContainer=a("<div />").append("<span id='"+this.options.id+"'>"+this.options.sampleName+"</span><a class='icon-remove icon-white pull-right'></a>").addClass("sample").attr("data-sample-options",JSON.stringify(this.options)),this.$sampleContainer.draggable(Mashup.properties.draggableDefaultOptions);var b=this.$sampleContainer;this.element.append(this.$sampleContainer).fadeIn(function(){b.animate({width:"100%",height:"30px"})})},_loadEffect:function(){if(this.options.effectType===-1)return;var a=Mashup.Player.audioPlayerGraphical("getEffect",this.options.effectType);this.convolver.buffer=a.effects("getBuffer")},_handleEvents:function(){this.$sampleContainer.find(".icon-remove").click(function(){Mashup.Player.audioPlayerGraphical("removeSampleById",a.sampleUniqueId)});var a=this;this.$sampleContainer.click(function(){a.showControls()})},_makeTrackRoom:function(){var b=Mashup.Player.audioPlayerGraphical("option","numberOfLoopBeats");if(this.startBeat+this.numberOfBeats>=b){var c=Math.ceil((this.startBeat+this.numberOfBeats+1)/4);b=c*4,Mashup.Player.audioPlayerGraphical("option","numberOfLoopBeats",b)}var d=Mashup.Player.audioPlayerGraphical("getTrackByIndex",this.options.track);for(var e=this.startBeat;e<this.startBeat+this.numberOfBeats;e++)if(d[e]!==0)throw"The sample overlaps another sample on the same track.";for(var f=0;f<this.numberOfBeats-1;f++)this.element.next().remove();this.element.removeClass("span1"),this.element.addClass("span"+this.numberOfBeats);var g=this.numberOfBeats/b*100;return a(".track .span"+this.numberOfBeats).width(g+"%"),!0},_restoreTrackRoom:function(){this.element.removeClass("span"+this.numberOfBeats);var a=100/Mashup.Player.audioPlayerGraphical("option","numberOfLoopBeats");this.element.addClass("span1").droppable(Mashup.properties.droppableDefaultOptions).css("width",a+"%");var b="<div class='span1' style='width:"+a+"%'></div>";console.log(b);var c=this.startBeat,d=this.element,e;for(var f=0;f<this.numberOfBeats-1;f++)e=b,d.after(e),d=d.next();this.element.parent().children(".span1").droppable(Mashup.properties.droppableDefaultOptions)},_updateOptionsOnPlayer:function(){var a=JSON.stringify(this.options);this.$sampleContainer.attr("data-sample-options",a)},_setOption:function(a,b){switch(a){case"volume":b=Math.pow(b,4),this.options.volume=b,this.buffer!==null&&(this.buffer.gain=b),this._updateOptionsOnPlayer();break;default:this.options[a]=b,this._updateOptionsOnPlayer()}this._super("_setOption",a,b)},getInitiated:function(){return this._initiated},hideControls:function(){a("#sampleSugar").slideUp(500),Mashup.Player.find(".sample").removeClass("edit")},play:function(a){this.$sampleContainer.addClass("playing")},showControls:function(){if(this.$sampleContainer.hasClass("edit")){this.hideControls();return}var b=a("#sampleSugar");Mashup.Player.find(".sample").removeClass("edit"),this.$sampleContainer.addClass("edit"),b.is(":visible")||b.slideDown(500),a("#purchaseSong").hide(),a.ajax({url:"/api/samples/"+this.options.id+"?format=json",success:function(b){b.Sample.BuyLink&&(a("#purchaseSong").attr("href",b.Sample.BuyLink),a("#purchaseSong").show())},error:Mashup.GenericErrorMessage}),a("#sampleArtist").text(this.options.artist),a("#sampleName").text(this.options.sampleName),a("#sampleBpm").text(this.options.bpm),a("#sampleBeats").text(this.numberOfBeats+" beats");var c=b.find(".slider-thumb"),d=this;a.each(c,function(b,c){var e=a(c).audioControl("option","sliderThumbId");e==="volume"?a(c).audioControl("sliderSetPosition",Math.pow(d.options[e],.25)):a(c).audioControl("sliderSetPosition",d.options[e])}),a(".slider-thumb").audioControl("option","sample",d.element),a("#effectList").unbind("change"),a("#shiftSample").unbind("change"),a("#effectList").val(d.options.effectType),a("#effectList").change(function(){d.options.effectType=parseInt(a(this).val()),d._updateOptionsOnPlayer(),d._loadEffect()});var e=Mashup.Player.audioPlayerGraphical("option","bpm")/60;a("#shiftSample").val(Math.round(d.options.shiftSample*e*16)),a("#shiftSample").change(function(){d.options.shiftSample=a(this).val()/(e*16),d._updateOptionsOnPlayer()}),a("#sampleLengthEdit").length>0&&(a("#sampleLengthEdit").remove(),a("#sampleEdit i").removeClass("icon-file"),a("#sampleEdit i").addClass("icon-edit"))},_destroy:function(){this._initiated?(this.$sampleContainer.draggable("destroy"),this.$sampleContainer.remove(),this._restoreTrackRoom()):this.element.droppable(Mashup.properties.droppableDefaultOptions)}})})(jQuery,window,document)