(function(a,b,c,d){a.widget("Mashup.audioViewer",{options:{width:null,height:null,sampleRate:48e3,playButton:null,zoomInButton:null,zoomOutButton:null,dropFileBox:null,audioPlayer:null},_create:function(){var b=this;this.options.width=this.options.width?this.options.width:a(this.element[0]).width(),this.options.height=this.options.height?this.options.height:a(this.element[0]).height();var d=a(this.options.audioPlayer);this.$audioPlayer=d.audioPlayerWaveformViewer(),Mashup.Player&&a("body").keydown(function(a){if(a.which===32){if(a.target.tagName.toUpperCase()==="INPUT")return;a.preventDefault(),b.togglePlay()}}),this.$playBtn=a(this.options.playButton),this.$playBtn.click(function(){b.togglePlay()}),this.$zoomInBtn=a(this.options.zoomInButton),this.$zoomInBtn.click(function(){b._isSelected()?(b.endWaveform=b._getSelectedWaveformEnd(),b.startWaveform=b._getSelectedWaveformStart(),b.processWave.zoomInSelected(b.startWaveform,b.endWaveform)):b.processWave.zoomIn(),b._setWaveformData(),b.processTrim.clear()}),this.$zoomOutBtn=a(this.options.zoomOutButton),this.$zoomOutBtn.click(function(){var a=b._isSelected();b._setViewerData(a),b.processWave.zoomOut(),b._setWaveformData();if(a){var c=Math.floor((b.playWaveformStart-b.startWaveform)/(b.endWaveform-b.startWaveform)*b.options.width),d=Math.floor((b.playWaveformEnd-b.startWaveform)/(b.endWaveform-b.startWaveform)*b.options.width);b.processTrim.setTrim(c,d)}});if(this.options.dropFileBox){var e=this.options.dropFileBox.replace("#","");this._dropBox=c.getElementById(e),this._dropBox.addEventListener("drop",function(a){b.drop(a)},!1),this._dropBox.addEventListener("dragover",function(a){b.dragEnter(a)},!1),this._dropBox.addEventListener("dragleave",function(a){b.dragLeave(a)},!1)}var f=setInterval(function(){b.processTrim=Processing.getInstanceById("sampleTrim"),b.processWave=Processing.getInstanceById("sampleWaveform"),b.processPlay=Processing.getInstanceById("samplePlayIndex"),b.processTrim&&b.processWave&&b.processPlay&&(clearInterval(f),b.processWave.setSize(b.options.width,b.options.height),b.processTrim.setSize(b.options.width,b.options.height),b.processPlay.setSize(b.options.width,b.options.height))},500)},_isSelected:function(){return this.processTrim.isSelected()},_getSelectedWaveformStart:function(){return Math.floor(this.totalWaveformLength*(this.processTrim.getMin()/this.options.width)*this.waveformFraction)+this.startWaveform},_getSelectedWaveformEnd:function(){return Math.floor(this.totalWaveformLength*(this.processTrim.getMax()/this.options.width)*this.waveformFraction)+this.startWaveform},_setWaveformData:function(){this.startWaveform=this.processWave.getWaveformStart(),this.endWaveform=this.processWave.getWaveformEnd(),this.waveformFraction=(this.endWaveform-this.startWaveform)/this.totalWaveformLength},_setViewerData:function(a){this.viewerWaveformLength=this.endWaveform-this.startWaveform,this.playWaveformStart=this.startWaveform,this.playWaveformLength=this.viewerWaveformLength,this.playWaveformEnd=this.startWaveform+this.viewerWaveformLength,a&&(this.playWaveformEnd=this._getSelectedWaveformEnd(),this.playWaveformStart=this._getSelectedWaveformStart(),this.playWaveformLength=this.playWaveformEnd-this.playWaveformStart)},_setOption:function(a,b){switch(a){default:this.options[a]=b}this._super("_setOption",a,b)},_setupPlayerandPlotWaveform:function(a){var b;typeof a=="undefined"?b=this.buffer.getChannelData(0):b=a,this.startWaveform=0,this.endWaveform=b.length,this.$audioPlayer.audioPlayerWaveformViewer("addSample",this.buffer),this.$audioPlayer.audioPlayerWaveformViewer("option","waveformStart",this.startWaveform),this.$audioPlayer.audioPlayerWaveformViewer("option","waveformEnd",this.duration),this.totalWaveformLength=b.length,this.waveformFraction=1,this.processWave.addSample(b,this.endWaveform),this.processTrim.clear()},calculateBpm:function(a){var b=this.getEndTime()-this.getStartTime();return a/b*60},clear:function(){this.processWave.clear()},drop:function(c){c.stopPropagation(),c.preventDefault(),Mashup.StartLoading("Loading and drawing song...."),a(c.target).removeClass("over");var e=c.dataTransfer.files,f=this;if(e.length>0)if(b.FormData!==d){var g=e[0];if(g.type!=="audio/mp3"&&g.type!=="audio/ogg"&&g.type!=="audio/wav"){Mashup.ShowMessage("Invalid File Type","File must be an .mp3, .ogg, or .wav file",Mashup.properties.messageType.Error),Mashup.EndLoading();return}var h=new FileReader;h.onloadend=function(b){a("#dropInfo").length>0&&a("#dropInfo").remove(),a("#audioViewerControls").length>0&&a("#audioViewerControls").show(),Mashup.EndLoading(),f.loadSampleFromArrayBuffer(this.result)},h.readAsArrayBuffer(g)}else Mashup.ShowMessage("D'oh!",'This application requires a File API enabled browser.  Please download <a href="http://www.google.com/chrome" title="chrome" target="_blank">Chrome</a> to take part in the fun! (Trust me, its quick, painless and well worth it)'),Mashup.EndLoading()},dragEnter:function(b){return b.stopPropagation(),b.preventDefault(),b.dataTransfer.files.length>0&&(b.dataTransfer.dropEffect="drop"),a(b.target).addClass("over"),!1},dragLeave:function(b){return b.stopPropagation(),b.preventDefault(),a(b.target).removeClass("over"),!1},getStartTime:function(a){if(this._isSelected()||a){var b=this.startWaveform/this.totalWaveformLength*this.duration;return this.processTrim.getMin()/this.options.width*this.duration*this.waveformFraction+b}return this.startWaveform/this.totalWaveformLength*this.duration},getEndTime:function(a){if(this._isSelected()||a){var b=this.startWaveform/this.totalWaveformLength*this.duration;return this.processTrim.getMax()/this.options.width*this.duration*this.waveformFraction+b}return this.endWaveform/this.totalWaveformLength*this.duration},getSampleBuffer:function(){return this.buffer.getChannelData(0)},getFinalSampleBuffer:function(){if(this.buffer===null)throw"You must load a song by dropping song on player";this._setViewerData(this._isSelected());var a=this.playWaveformStart*4,b=this.playWaveformEnd*4,c=b-a;if(c>Mashup.properties.maxSampleLength)throw"Sample is too long.  Please keep sample under 90 seconds";var d=this.normalizeSample(),e=PCMData.encode({data:d,sampleRate:44100,channelCount:2,bytesPerSample:2});return e},isPlaying:function(){return!this.$playBtn.children("i").hasClass("icon-play")},loadSampleFromArrayBuffer:function(a){this.buffer=this.$audioPlayer.audioPlayerWaveformViewer("getContext").createBuffer(a,!1),this.duration=this.buffer.duration,this._setupPlayerandPlotWaveform()},loadSampleFromFileUrl:function(a,b,c){this.id=b,this.duration=c;var d=Mashup.Player.audioPlayerGraphical("getLoadedSampleById",this.id);if(typeof d.buffer!="undefined"){this.buffer=d.buffer,this._setupPlayerandPlotWaveform();return}var e=this,f=Mashup.properties.sampleFilePath+a,g=new XMLHttpRequest;g.open("GET",f,!0),g.responseType="arraybuffer",g.onload=function(){e.loadSampleFromArrayBuffer(g.response)},g.send()},normalizeSample:function(){var a=new Float32Array(this.buffer.getChannelData(0).buffer),b=2500,c=0,d=Math.floor((this.playWaveformEnd-this.playWaveformStart)/b);for(var e=this.playWaveformStart;e<this.playWaveformEnd;e+=d)a[e]>c&&(c=a[e]);var f=.7/c,g=new Float32Array(this.playWaveformEnd-this.playWaveformStart);for(var h=this.playWaveformStart;h<this.playWaveformEnd;h++)g[h-this.playWaveformStart]=a[h]*f;return g},movePlayIndicator:function(){var a=this.getStartTime(!0),b=this.getEndTime(!0);this.$audioPlayer.audioPlayerWaveformViewer("option","waveformStart",a),this.$audioPlayer.audioPlayerWaveformViewer("option","waveformEnd",b),this._setViewerData(!0),this.processPlay.setupPlay(this.viewerWaveformLength,this.playWaveformStart-this.startWaveform,this.playWaveformLength,this.options.sampleRate)},play:function(){this.$playBtn.children("i").removeClass("icon-play").addClass("icon-stop"),this.movePlayIndicator(),this.processPlay.play(),this.$audioPlayer.audioPlayerWaveformViewer("play"),this.$zoomInBtn.attr("disabled","disabled"),this.$zoomOutBtn.attr("disabled","disabled"),a("title").text("▶ "+a("title").text())},stop:function(){this.$playBtn.children("i").removeClass("icon-stop").addClass("icon-play"),this.processPlay.stop(),this.$audioPlayer.audioPlayerWaveformViewer("stop"),this.$zoomInBtn.removeAttr("disabled"),this.$zoomOutBtn.removeAttr("disabled"),a("title").text(a("title").text().replace(/▶/g,""))},togglePlay:function(){this.isPlaying()?this.stop():this.play()},_destroy:function(){this.$playBtn.unbind("click"),this.$zoomInBtn.unbind("click"),this.$zoomOutBtn.unbind("click"),this._dropBox.removeEventListener("drop"),this._dropBox.removeEventListener("dragover"),this._dropBox.removeEventListener("dragleave")}})})(jQuery,window,document)