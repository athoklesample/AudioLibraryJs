(function(a,b,c,d){a.widget("Mashup.audioPlayer",{options:{bpm:115,numberOfLoopBeats:16,rhythmIndex:0,beatIncrement:4,tracks:5},isGraphical:!1,rhythmIndex:0,isLoaded:!1,stopped:!0,_samples:[],_loadedSamples:[],_tracks:[],_effects:[],_uniqueSampleIdentifier:1,_create:function(){if(b.webkitAudioContext)this.context=new webkitAudioContext;else throw'This application requires a Web Audio API enabled browser.  Please download <a href="http://www.google.com/chrome" title="chrome" target="_blank">Chrome</a> to take part in the fun! (Trust me, its quick, painless and well worth it)';var c;this.context.createDynamicsCompressor?(this.compressor=this.context.createDynamicsCompressor(),this.compressor.connect(this.context.destination),c=this.compressor):c=this.context.destination,this.masterGainNode=this.context.createGainNode(),this.masterGainNode.gain.value=.7,this.masterGainNode.connect(c),this.effectLevelNode=this.context.createGainNode(),this.effectLevelNode.gain.value=1,this.effectLevelNode.connect(this.masterGainNode),this.isGraphical||this._setupTracks(),this.$player=a(this.element[0])},_addTrack:function(){var a=[];for(var b=0;b<this.options.numberOfLoopBeats;b++)a.push(0);this._tracks.push(a)},_addBeatsToTracks:function(a){var b=[];for(var c=0;c<a;c++)b.push(0);for(var d=0;d<this._tracks.length;d++)this._tracks[d]=this._tracks[d].concat(b)},_advanceNote:function(){var a=60/this.options.bpm;this.rhythmIndex++,this.rhythmIndex===this.options.numberOfLoopBeats*this.options.beatIncrement&&(this.rhythmIndex=0,this._currentBeat=0),this.noteTime+=a/this.options.beatIncrement},_checkSamples:function(){var b=this,c=a.grep(this._samples,function(a){var c=a.sample("getStartTime");return c>=b._timerCounter&&c<b._timerCounter+b.options.timerInterval||b._timerCounter<a.sample("getEndTime")&&a.sample("hasSampleStarted")});a.each(c,function(a,b){b.sample("option","sampleStarted",!0),b.sample("play")})},_loadEffects:function(){var b=a("#effectList option").length,c=this;for(var d=1;d<b;d++){var e=a("#effectList option").eq(d),f={wetMix:e.attr("data-wet"),dryMix:e.attr("data-dry"),url:e.attr("data-url"),effectType:e.val(),context:c.context};this._effects.push(e.effects(f))}},_playNote:function(a,b,c,d,e,f,g,h,i,j,k,l,m){var n=this.context.createBufferSource();n.buffer=this.isGraphical?a.audioSampleGraphical("getBuffer"):a.audioSample("getBuffer"),n.playbackRate.value=j,this.isGraphical?a.audioSampleGraphical("setBufferNode",n):a.audioSample("setBufferNode",n);var o;if(b){var p=this.context.createPanner();p.panningModel=webkitAudioPannerNode.HRTF,p.setPosition(c,d,e),p.setOrientation(-c,d,e),p.coneInnerAngle=1,p.coneOuterGain=0,n.connect(p),o=p}else o=n;if(!f)o.connect(this.masterGainNode);else{var q=this.getEffect(g),r=this.isGraphical?a.audioSampleGraphical("option","effect"):a.audioSample("option","effect"),s=q.effects("option","dryMix"),t=q.effects("option","wetMix"),u=this.isGraphical?a.audioSampleGraphical("getConvolver"):a.audioSample("getConvolver");u.connect(this.effectLevelNode);var v=this.context.createGainNode();v.gain.value=i*s,o.connect(v),v.connect(this.masterGainNode);var w=this.context.createGainNode();w.gain.value=t*r,o.connect(w),w.connect(u)}n.noteGrainOn(k,l,m)},_removeBeatsFromTrack:function(a,b,c){var d=a-b,e=this._tracks[c].splice(d,b);this._removeSamplesFromTrack(e)},_removeSamplesFromTrack:function(b){var c=a.grep(b,function(a){return a!=0});while(c.length>0){var d=c[0];this.removeSampleById(d),c=a.grep(c,function(a,b){return a!=d})}},_removeTrack:function(){this._removeTrackAtIndex(0)},_removeTrackAtIndex:function(a){this._removeSamplesFromTrack(this._tracks[a]),this._tracks.splice(a,1)},_setupTracks:function(){for(var a=0;a<this.options.tracks;a++)this._addTrack()},_stopSamples:function(){var b=this;a.each(this._samples,function(a,c){b.isGraphical?c.audioSampleGraphical("stop",b.noteTime):c.audioSample("stop",b.noteTime)})},_setOption:function(a,b){switch(a){case"numberOfLoopBeats":this.adjustNumberOfBeats(b),this.options.numberOfLoopBeats=b;break;default:this.options[a]=b}this._super("_setOption",a,b)},_waitForSamples:function(){this._toggle.text("").append('<i class="icon-refresh icon-white"></i>');var b=this,c=setInterval(function(){try{a.each(b._samples,function(a,b){b.audioSample("getBuffer")}),Mashup.EndLoading(),b.isLoaded=!0,b.play(),clearInterval(c)}catch(d){}},1e3)},addLoadedSample:function(a){this._loadedSamples.push(a)},addSample:function(a){var b=this._uniqueSampleIdentifier++;this.isGraphical?a.audioSampleGraphical("setUniqueIdentifier",b):a.audioSample("setUniqueIdentifier",b),this.addOrRemoveSampleToTrack(a,b),this._samples.push(a)},addOrRemoveSampleToTrack:function(a,b){var c=this.isGraphical?a.audioSampleGraphical("option","track"):a.audioSample("option","track"),d=this.isGraphical?a.audioSampleGraphical("getStartBeat"):a.audioSample("getStartBeat"),e=this.isGraphical?a.audioSampleGraphical("getNumberOfBeats"):a.audioSample("getNumberOfBeats"),f=this._tracks[c];for(var g=d;g<e+d;g++)f[g]=b},adjustNumberOfBeats:function(a){var b=this._tracks[0].length;if(a>b){var c=a-b;this._addBeatsToTracks(c)}else{var d=b-a;for(var e=0;e<this.options.tracks+1;e++)this._removeBeatsFromTrack(b,d,e)}},getContext:function(){return this.context},getEffect:function(b){return a.grep(this._effects,function(a){return a.effects("option","effectType")==b})[0]},getLoadedSampleById:function(b){return a.grep(this._loadedSamples,function(a){return a.id===b})[0]},getSampleByUniqueId:function(b){var c=this;return a.grep(this._samples,function(a){return c.isGraphical?a.audioSampleGraphical("getUniqueIdentifier")===b:a.audioSample("getUniqueIdentifier")===b})[0]},getTrackByIndex:function(a){return this._tracks[a]},loadMix:function(b){var c=JSON.parse(b);this.options=c.player,this.reset(),this.isLoaded=!1;var d=this;this.adjustNumberOfBeats(c.player.numberOfLoopBeats),Mashup.StartLoading(),setTimeout(function(){a.each(c.samples,function(b,c){var e=a("<div />").append("&nbsp;");a("#player").append(e);var f=e.audioSample(c);d.addSample(f)})},10),this.play()},play:function(){this.isLoaded?(this.stopped&&(this.noteTime=0,this.stopped=!1),this.startTime=this.context.currentTime-this.noteTime+.005,this._toggle.text("").append('<i class="icon-pause icon-white"></i>'),this._isPlaying=!0,this.schedule()):this._waitForSamples(),a("title").text("▶ "+a("title").text())},pause:function(){this._stopSamples(),this._toggle.text("").append('<i class="icon-play icon-white"></i>'),this._isPlaying=!1,clearTimeout(this.timeoutId),a("title").text(a("title").text().replace(/▶/g,""))},removeSampleById:function(a){var b=this.getSampleByUniqueId(a);this.addOrRemoveSampleToTrack(b,0);var c=this._samples.indexOf(b);this.removeSampleByIndex(c)},removeSampleByIndex:function(a){var b=this._samples[a];this.isGraphical?b.audioSampleGraphical("destroy"):b.audioSample("destroy"),this._samples.splice(a,1)},reset:function(){var b=this;b.stop();for(var c=this.options.tracks-1;c>=0;c--)b._removeTrackAtIndex(c);this._tracks=[],this._setupTracks(),a("#mashId").val("0"),a("#playerSave").text("Save")},schedule:function(){var a=this.context.currentTime;a-=this.startTime;while(this.noteTime<a+.2){var b=this.noteTime+this.startTime;for(var c=0;c<this._samples.length;c++){var d=this._samples[c],e=this.isGraphical?d.audioSampleGraphical("option","rhythmIndex"):d.audioSample("option","rhythmIndex");if(this.rhythmIndex===parseInt(e)){var f=this.isGraphical?d.audioSampleGraphical("getOptions"):d.audioSample("getOptions"),g=f.bpm===0?1:this.options.bpm/f.bpm,h=-5+10*f.pan,i=h!=0,j=f.effectType,k=j!==-1,l=f.trimStart,m=f.playDuration-.01,n=f.shiftSample;this._playNote(d,i,h,0,0,k,j,0,1,g,b+n,l,m)}}this._advanceNote()}this.timeoutId=this.isGraphical?setTimeout("Mashup.Player.audioPlayerGraphical('schedule')",0):setTimeout("Mashup.Player.audioPlayer('schedule')",0)},setToggle:function(b){this._toggle=a(b)},stop:function(){this.stopped=!0,this._isPlaying=!1,this._stopSamples(),this._toggle.text("").append('<i class="icon-play icon-white"></i>'),clearTimeout(this.timeoutId),this.rhythmIndex=0,this._currentBeat=0,a("title").text(a("title").text().replace(/▶/g,""))},updateLoadedSample:function(b){var c=a.grep(this._loadedSamples,function(a){return a.id===b.id})[0];c.buffer=b.buffer;if(this.isGraphical)for(var d=0;d<this._samples.length;d++)this._samples[d].audioSampleGraphical("option","id")===b.id&&this._samples[d].audioSampleGraphical("setBuffer",b.buffer);else for(var d=0;d<this._samples.length;d++)this._samples[d].audioSample("option","id")===b.id&&this._samples[d].audioSample("setBuffer",b.buffer)},_destroy:function(){this.reset(),this._samples=null,this._tracks=null,this._loadedSamples=null,this._toggle.unbind("click")}})})(jQuery,window,document)